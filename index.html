<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Оперативно Єціль | LIVE</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --main-yellow: #ffeb3b;
            --glow: 0 0 15px rgba(255, 235, 59, 0.4);
            --card-bg: rgba(22, 27, 34, 0.95);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #fff; overflow: hidden; }
        #map { height: 100vh; width: 100%; transition: filter 1s ease; filter: blur(15px) brightness(0.8); z-index: 1; }
        .map-active { filter: blur(0px) brightness(1) !important; }

        /* ВОДЯНИЙ ЗНАК */
        #watermark-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2; pointer-events: none; white-space: nowrap;
            font-weight: 900; text-transform: uppercase; letter-spacing: 5px;
            font-size: 5vw; opacity: 0.1; color: #000; display: none;
        }

        /* ВЕРХНЯ ПАНЕЛЬ */
        #top-status-bar {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            z-index: 5000; background: #000; border: 1px solid var(--main-yellow);
            backdrop-filter: blur(10px); box-shadow: var(--glow); border-radius: 20px;
            padding: 8px 20px; display: flex; align-items: center; gap: 25px;
            color: white; font-size: 13px; font-weight: bold;
            transition: top 0.7s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        /* КНОПКА НАЛАШТУВАНЬ */
        #settings-btn {
            position: fixed; bottom: 25px; right: 25px; z-index: 6000;
            background: #000; border: 1px solid var(--main-yellow);
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--glow); opacity: 0; 
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #settings-btn.open { bottom: 420px; right: 35px; transform: scale(0.9); }
        #settings-btn svg { width: 26px; height: 26px; fill: var(--main-yellow); transition: 0.5s; }

        /* ПАНЕЛЬ НАЛАШТУВАНЬ */
        #settings-panel {
            position: fixed; bottom: 25px; right: 25px;
            z-index: 5500; background: var(--card-bg); border: 1px solid var(--main-yellow);
            backdrop-filter: blur(15px); box-shadow: var(--glow); border-radius: 25px;
            padding: 20px; width: 260px; color: white;
            pointer-events: none; opacity: 0; transform: scale(0.8); transform-origin: bottom right;
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #settings-panel.active { pointer-events: auto; opacity: 1; transform: scale(1); }

        .setting-row { display: flex; align-items: center; justify-content: space-between; margin: 12px 0; font-size: 13px; font-weight: 600; }
        .input-dark { background: #000; border: 1px solid #444; color: white; border-radius: 5px; padding: 4px; font-size: 11px; width: 100px; }
        
        .unit-icon { width: 32px; height: 32px; transition: transform 0.1s linear; }

        /* АВТОРИЗАЦІЯ */
        #auth-overlay { position: fixed; inset: 0; background: #0d1117; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: 0.8s; }
        .auth-card { width: 85%; max-width: 350px; text-align: center; background: #161b22; padding: 40px 25px; border-radius: 35px; border: 2px solid var(--main-yellow); box-shadow: var(--glow); }
        .nick-input { width: 85%; background: #000; border: 1px solid var(--main-yellow); border-radius: 12px; padding: 15px; color: white; text-align: center; margin-bottom: 25px; outline: none; }
        .btn-start { background: var(--main-yellow); color: #000; border: none; padding: 15px 50px; border-radius: 30px; font-weight: 900; cursor: pointer; }
        .auth-hidden { opacity: 0 !important; visibility: hidden !important; }
    </style>
</head>
<body>

    <div id="watermark-overlay">ЄЦІЛЬ</div>

    <div id="auth-overlay">
        <div class="auth-card">
            <div style="color: var(--main-yellow); font-size: 32px; font-weight: 900; line-height:1; margin-bottom: 30px;">ОПЕРАТИВНО<br>ЄЦІЛЬ</div>
            <input type="text" id="user-nick" class="nick-input" placeholder="Позивний">
            <button class="btn-start" id="start-btn">УВІЙТИ</button>
        </div>
    </div>

    <div id="top-status-bar">
        <div style="text-align:center"><span style="color:var(--main-yellow); font-size:8px; display:block">ПРОЄКТ</span><span>ЄЦІЛЬ</span></div>
        <div style="text-align:center"><span style="color:var(--main-yellow); font-size:8px; display:block">ПОЗИВНИЙ</span><span id="display-nick">---</span></div>
        <div style="text-align:center"><span style="color:var(--main-yellow); font-size:8px; display:block">ОНЛАЙН</span><span id="online-num" style="color:#4caf50">1</span></div>
    </div>

    <div id="settings-btn">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
    </div>

    <div id="settings-panel">
        <div style="text-align:center; color:var(--main-yellow); font-weight:900; font-size:11px; margin-bottom:12px; letter-spacing:2px;">НАЛАШТУВАННЯ</div>
        
        <div class="setting-row"><span>Темна мапа</span><input type="checkbox" id="toggle-map-theme"></div>
        <div class="setting-row"><span>Червоний слід</span><input type="checkbox" id="toggle-trails" checked></div>
        <div class="setting-row"><span>Пуски Shahed</span><input type="checkbox" id="toggle-shahed" checked></div>
        
        <div style="height:1px; background:#444; margin:10px 0;"></div>
        <div style="text-align:center; color:var(--main-yellow); font-weight:900; font-size:9px; margin-bottom:10px;">ВОДЯНИЙ ЗНАК</div>
        
        <div class="setting-row"><span>Текст</span><input type="text" id="wm-text" class="input-dark" placeholder="Текст..."></div>
        <div class="setting-row"><span>Колір</span><input type="color" id="wm-color" value="#000000" style="border:none; background:none; cursor:pointer; width:30px;"></div>
        <div class="setting-row"><span>Прозорість</span><input type="range" id="wm-opacity" min="0" max="1" step="0.1" value="0.1" style="width:60px;"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.37, 31.16], 6);
        
        const lightTheme = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        const darkTheme = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        
        // По замовчуванню світла
        lightTheme.addTo(map);

        const shahedLayer = L.layerGroup().addTo(map);
        const units = {};

        // --- ПЕРЕМИКАЧ ТЕМИ ---
        document.getElementById('toggle-map-theme').onchange = (e) => {
            if(e.target.checked) {
                map.removeLayer(lightTheme);
                darkTheme.addTo(map);
                document.body.style.background = "#000";
            } else {
                map.removeLayer(darkTheme);
                lightTheme.addTo(map);
                document.body.style.background = "#fff";
            }
        };

        // --- ВОДЯНИЙ ЗНАК ---
        const wm = document.getElementById('watermark-overlay');
        document.getElementById('wm-text').oninput = (e) => {
            wm.innerText = e.target.value;
            wm.style.display = e.target.value ? 'block' : 'none';
        };
        document.getElementById('wm-color').oninput = (e) => wm.style.color = e.target.value;
        document.getElementById('wm-opacity').oninput = (e) => wm.style.opacity = e.target.value;

        // --- НАЛАШТУВАННЯ ---
        document.getElementById('settings-btn').onclick = function() {
            this.classList.toggle('open');
            document.getElementById('settings-panel').classList.toggle('active');
        };

        let showTrails = true;
        document.getElementById('toggle-trails').onchange = (e) => {
            showTrails = e.target.checked;
            Object.values(units).forEach(u => {
                if(showTrails) map.addLayer(u.t); else map.removeLayer(u.t);
            });
        };

        // --- ВХІД ---
        document.getElementById('start-btn').onclick = () => {
            const nick = document.getElementById('user-nick').value.trim();
            if (nick.length >= 2) {
                const pRef = push(ref(db, 'presence')); set(pRef, { name: nick }); onDisconnect(pRef).remove();
                document.getElementById('auth-overlay').classList.add('auth-hidden');
                document.getElementById('map').classList.add('map-active');
                document.getElementById('display-nick').innerText = nick;
                document.getElementById('top-status-bar').style.top = "15px";
                document.getElementById('settings-btn').style.opacity = "1";
            }
        };

        // --- ОНОВЛЕННЯ ЦІЛЕЙ ---
        onValue(ref(db, 'live_units'), snap => {
            const data = snap.val() || [];
            data.forEach(u => {
                const id = u.id.toString();
                if (!units[id]) {
                    const m = L.marker([u.lat, u.lng], {
                        icon: L.divIcon({
                            className: 'u-wrap',
                            html: `<img src="${u.icon}" class="unit-icon" style="transform:rotate(${u.ang||0}deg)">`,
                            iconSize: [32, 32], iconAnchor: [16, 16]
                        })
                    }).addTo(map);
                    const t = L.polyline([[u.lat, u.lng]], { color: 'red', weight: 4, opacity: 0.6 });
                    if(showTrails) t.addTo(map);
                    units[id] = { m, t, h: [[u.lat, u.lng]] };
                } else {
                    units[id].m.setLatLng([u.lat, u.lng]);
                    units[id].h.push([u.lat, u.lng]);
                    units[id].t.setLatLngs(units[id].h);
                }
            });
        });
    </script>
</body>
</html>
