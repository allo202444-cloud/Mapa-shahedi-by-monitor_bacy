<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Карта мониторинга</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map { margin: 0; padding: 0; height: 100%; width: 100%; background: #fff; }
        .unit-icon { width: 32px; height: 32px; transition: transform 0.2s; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const map = L.map('map', { zoomControl: false }).setView([48.3, 31.1], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const markers = {}, lines = {};

        onValue(ref(db, 'live_units'), (s) => {
            const data = s.val() || [];
            const ids = data.map(d => d.id.toString());

            Object.keys(markers).forEach(id => {
                if(!ids.includes(id)) { map.removeLayer(markers[id]); map.removeLayer(lines[id]); delete markers[id]; delete lines[id]; }
            });

            data.forEach(u => {
                const id = u.id.toString();
                if(!markers[id]) {
                    const i = L.divIcon({ html: `<img src="${u.icon}" class="unit-icon" style="transform:rotate(${u.ang}deg)">`, iconSize:[32,32], iconAnchor:[16,16], className:'' });
                    markers[id] = L.marker([u.lat, u.lng], {icon:i}).addTo(map);
                    lines[id] = L.polyline([[u.lat, u.lng], u.tLat ? [u.tLat, u.tLng] : [u.lat, u.lng]], {color:'blue', weight:2, dashArray:'5,5', opacity:0.5}).addTo(map);
                } else {
                    markers[id].setLatLng([u.lat, u.lng]);
                    lines[id].setLatLngs([[u.lat, u.lng], u.tLat ? [u.tLat, u.tLng] : [u.lat, u.lng]]);
                    const img = markers[id].getElement()?.querySelector('img');
                    if(img) img.style.transform = `rotate(${u.ang}deg)`;
                }
            });
        });
    </script>
</body>
</html>
